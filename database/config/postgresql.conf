# PostgreSQL Configuration for LokDarpan Phase 1
# Optimized for e2-medium VM (4GB RAM, 2 vCPU) running political intelligence workloads

# =============================================================================
# MEMORY AND CPU CONFIGURATION
# =============================================================================

# Memory settings optimized for e2-medium VM with 4GB RAM
shared_buffers = 1GB                    # 25% of total RAM
effective_cache_size = 3GB              # 75% of total RAM
work_mem = 16MB                         # Per connection sort/hash memory
maintenance_work_mem = 256MB            # Maintenance operations
max_connections = 100                   # Reasonable for medium workload

# =============================================================================
# WAL (Write-Ahead Logging) CONFIGURATION FOR RELIABILITY
# =============================================================================

wal_buffers = 16MB
checkpoint_completion_target = 0.9
checkpoint_timeout = 10min
max_wal_size = 2GB
min_wal_size = 1GB

# Point-in-Time Recovery Configuration
wal_level = replica
archive_mode = on
archive_command = 'test ! -f /backups/wal_archive/%f && cp %p /backups/wal_archive/%f'
archive_timeout = 300
max_wal_senders = 3
wal_keep_size = 1GB

# =============================================================================
# QUERY PLANNING AND PERFORMANCE OPTIMIZATION
# =============================================================================

# SSD optimization
random_page_cost = 1.1                  
effective_io_concurrency = 200          # SSD concurrent I/O
default_statistics_target = 500         # Better query planning for complex political queries

# =============================================================================
# POLITICAL INTELLIGENCE WORKLOAD OPTIMIZATION
# =============================================================================

# Temporary table operations for analytics
temp_buffers = 32MB                     
max_prepared_transactions = 100         # For complex analytical queries

# Parallel query execution
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# =============================================================================
# LOGGING CONFIGURATION FOR MONITORING
# =============================================================================

log_destination = 'stderr'
log_statement = 'ddl'                   # Log schema changes
log_min_duration_statement = 1000ms     # Log slow queries (>1 second)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on

# Additional logging for production monitoring
log_autovacuum_min_duration = 0
log_temp_files = 10MB

# =============================================================================
# CONNECTION AND AUTHENTICATION
# =============================================================================

listen_addresses = '*'
port = 5432
max_connections = 100

# Connection pooling optimization
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# =============================================================================
# AUTOVACUUM OPTIMIZATION FOR HIGH-WRITE WORKLOADS
# =============================================================================

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# =============================================================================
# EXTENSIONS AND ADDITIONAL CONFIGURATION
# =============================================================================

# Enable query statistics collection
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# Time zone
timezone = 'UTC'
log_timezone = 'UTC'

# Locale settings
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# SSL configuration (enable for production)
#ssl = on
#ssl_cert_file = 'server.crt'
#ssl_key_file = 'server.key'

# Password encryption
password_encryption = scram-sha-256