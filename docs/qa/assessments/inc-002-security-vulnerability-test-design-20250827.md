# Test Design: API Key Security Exposure (INC-002)

Date: 2025-08-27  
Designer: Quinn (Test Architect)  
Incident: Critical security vulnerability - API keys exposed

## Test Strategy Overview

- Total test scenarios: 12
- Unit tests: 3 (25%)
- Integration tests: 5 (42%)
- E2E tests: 4 (33%)
- Priority distribution: P0: 7, P1: 3, P2: 2

## Test Scenarios by Security Domain

### SD1: API Key Exposure Detection

#### Scenarios

| ID             | Level       | Priority | Test                                    | Justification                                |
|----------------|-------------|----------|----------------------------------------|---------------------------------------------|
| INC-002-UNIT-001 | Unit        | P0       | Secret pattern detection in code       | Validate secret scanning logic              |
| INC-002-UNIT-002 | Unit        | P0       | API key validation format checks       | Input security validation                   |
| INC-002-INT-001  | Integration | P0       | Repository secret scanning             | Comprehensive code security audit           |
| INC-002-INT-002  | Integration | P0       | Git history secret detection          | Historical exposure verification            |
| INC-002-E2E-001  | E2E         | P0       | End-to-end secret exposure audit      | Complete security assessment workflow       |

### SD2: API Key Rotation & Management

#### Scenarios

| ID             | Level       | Priority | Test                                    | Justification                                |
|----------------|-------------|----------|----------------------------------------|---------------------------------------------|
| INC-002-INT-003  | Integration | P0       | API key revocation verification       | Security remediation validation             |
| INC-002-INT-004  | Integration | P0       | New API key functionality testing     | Post-rotation service verification          |
| INC-002-E2E-002  | E2E         | P0       | Service functionality with new keys   | Complete service restoration validation     |
| INC-002-E2E-003  | E2E         | P1       | Revoked key rejection testing         | Security enforcement validation             |

### SD3: Secrets Management Infrastructure

#### Scenarios

| ID             | Level       | Priority | Test                                    | Justification                                |
|----------------|-------------|----------|----------------------------------------|---------------------------------------------|
| INC-002-UNIT-003 | Unit        | P1       | Environment variable sanitization     | Runtime security validation                 |
| INC-002-INT-005  | Integration | P1       | Secrets management system integration | Infrastructure security testing             |
| INC-002-E2E-004  | E2E         | P2       | Pre-commit hook secret prevention    | Development workflow security validation    |

## Critical Security Test Framework

### P0 Security Validation Tests

#### 1. Repository Secret Scanning
```bash
#!/bin/bash
# INC-002-INT-001: Comprehensive repository secret scan

# Test current codebase for exposed secrets
git-secrets --scan --recursive .
rg "AIzaSy[A-Za-z0-9_-]{35}" --type-not=md || echo "✅ No Gemini keys found"
rg "sk-proj-[A-Za-z0-9_-]{48}" --type-not=md || echo "✅ No OpenAI keys found"  
rg "pplx-[A-Za-z0-9_-]{32}" --type-not=md || echo "✅ No Perplexity keys found"
rg "AAAAAAAAAAAAAAAA[A-Za-z0-9%_-]+" --type-not=md || echo "✅ No Twitter tokens found"

# Verify .gitignore protection
if grep -q "*.env" .gitignore; then
  echo "✅ Environment files protected"
else
  echo "❌ FAIL: .gitignore missing .env protection"
  exit 1
fi
```

#### 2. Git History Security Audit
```bash
#!/bin/bash  
# INC-002-INT-002: Historical secret exposure detection

# Scan entire git history for exposed keys
git log --all --full-history -- "*.env*" | head -20
git log --all --grep="AIzaSy\|sk-proj-\|pplx-" --oneline --since="2025-01-01"

# Verify specific exposed keys are no longer present
EXPOSED_KEYS=(
  "AIzaSyB8gGrXaJdQHSJgMfxkxRhzEHG8a5FoJoM"
  "sk-proj-GIfCdHMDi"
  "pplx-8mD9OV67"
)

for key in "${EXPOSED_KEYS[@]}"; do
  if git log --all --source --all -S "$key" --oneline | head -1; then
    echo "⚠️  Key $key found in git history - consider git-filter-repo"
  fi
done
```

#### 3. API Key Revocation Verification  
```python
# INC-002-INT-003: Verify exposed keys are revoked
import requests
import os

def test_gemini_key_revoked():
    """P0: Verify exposed Gemini key is revoked"""
    exposed_key = "AIzaSyB8gGrXaJdQHSJgMfxkxRhzEHG8a5FoJoM"
    
    response = requests.get(
        f"https://generativelanguage.googleapis.com/v1/models?key={exposed_key}"
    )
    
    # Should return 403 Forbidden or 401 Unauthorized
    assert response.status_code in [401, 403], f"❌ Exposed key still active: {response.status_code}"
    print("✅ Exposed Gemini key successfully revoked")

def test_new_keys_functional():
    """P0: Verify new API keys work correctly"""
    new_gemini_key = os.getenv('GEMINI_API_KEY')
    assert new_gemini_key is not None, "❌ New Gemini key not configured"
    assert not new_gemini_key.startswith('AIzaSyB8gGr'), "❌ Still using exposed key"
    
    response = requests.get(
        f"https://generativelanguage.googleapis.com/v1/models?key={new_gemini_key}"
    )
    assert response.status_code == 200, f"❌ New key non-functional: {response.status_code}"
    print("✅ New API keys functional")
```

### Integration Test Framework

```python
# strategist/tests/test_security_integration.py
import pytest
from unittest.mock import patch, MagicMock

class TestSecurityIntegration:
    
    def test_environment_variable_sanitization(self):
        """P1: Verify sensitive data not logged"""
        with patch('logging.Logger.info') as mock_log:
            # Trigger code that might log environment variables
            from strategist.service import initialize_ai_services
            initialize_ai_services()
            
            # Verify no API keys in log calls
            for call in mock_log.call_args_list:
                log_message = str(call)
                assert 'AIzaSy' not in log_message, "API key logged"
                assert 'sk-proj-' not in log_message, "OpenAI key logged"
                assert 'pplx-' not in log_message, "Perplexity key logged"
    
    def test_secrets_management_integration(self):
        """P1: Verify secrets loaded from secure storage"""
        # Test that secrets come from environment, not hardcoded
        import strategist.service as service
        
        # Should not contain any hardcoded secrets
        source_code = inspect.getsource(service)
        assert 'AIzaSy' not in source_code, "Hardcoded Gemini key found"
        assert 'sk-proj-' not in source_code, "Hardcoded OpenAI key found"
        assert 'pplx-' not in source_code, "Hardcoded Perplexity key found"
```

### E2E Security Testing

```javascript
// e2e/security/api-key-security.spec.js
import { test, expect } from '@playwright/test';

test.describe('API Key Security', () => {
  
  test('Application functions with new API keys', async ({ page }) => {
    // P0: End-to-end functionality with rotated keys
    await page.goto('/dashboard');
    
    // Request political analysis (uses AI APIs)
    await page.selectOption('#ward-select', 'Jubilee Hills');
    await page.click('#request-analysis');
    
    // Should succeed with new keys
    await expect(page.locator('.analysis-results')).toBeVisible({ timeout: 30000 });
    
    // Verify no error messages about API keys
    const errorMessages = await page.locator('.error-message').allTextContents();
    for (const error of errorMessages) {
      expect(error.toLowerCase()).not.toContain('api key');
      expect(error.toLowerCase()).not.toContain('unauthorized');
      expect(error.toLowerCase()).not.toContain('forbidden');
    }
  });
  
  test('Revoked keys are rejected by services', async ({ page, context }) => {
    // P1: Verify old keys cannot be used
    const EXPOSED_GEMINI_KEY = "AIzaSyB8gGrXaJdQHSJgMfxkxRhzEHG8a5FoJoM";
    
    // Intercept API calls and inject old key
    await page.route('**/api/v1/strategist/**', async route => {
      const request = route.request();
      const headers = {
        ...request.headers(),
        'X-Test-Use-Exposed-Key': 'true'
      };
      
      await route.continue({
        headers
      });
    });
    
    await page.goto('/dashboard');
    await page.selectOption('#ward-select', 'Jubilee Hills');
    await page.click('#request-analysis');
    
    // Should show authentication error
    await expect(page.locator('.error-message')).toBeVisible();
    const errorText = await page.locator('.error-message').textContent();
    expect(errorText.toLowerCase()).toContain('authentication');
  });
});
```

## Pre-Commit Hook Security Testing

```yaml
# .pre-commit-config.yaml - Security test validation
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: detect-private-key
      - id: check-added-large-files
        args: ['--maxkb=1000']
      
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0  
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
        exclude: .*\.md$|.*\.yml$
```

```bash
# INC-002-E2E-004: Pre-commit hook validation
#!/bin/bash

# Test that pre-commit hooks prevent secret commits
echo "AIzaSyB8gGrXaJdQHSJgMfxkxRhzEHG8a5FoJoM" > test_secret.py
git add test_secret.py

if git commit -m "Test commit with secret"; then
  echo "❌ FAIL: Pre-commit hooks did not prevent secret commit"
  git reset --hard HEAD~1  # Cleanup
  exit 1
else
  echo "✅ Pre-commit hooks successfully prevented secret commit"
  git reset HEAD test_secret.py
  rm test_secret.py
fi
```

## Security Monitoring & Alerting Tests

### Continuous Security Monitoring
```bash
# INC-002-INT-005: Automated security monitoring
#!/bin/bash

# Test security monitoring setup
if command -v git-secrets &> /dev/null; then
  echo "✅ git-secrets installed for secret scanning"
else
  echo "❌ git-secrets not installed - security gap"
fi

# Test automated scanning in CI/CD
if grep -r "detect-secrets\|git-secrets" .github/workflows/; then
  echo "✅ Automated secret scanning configured in CI/CD"  
else
  echo "❌ No automated secret scanning in CI/CD pipeline"
fi

# Test secret rotation monitoring
if [ -f "security_audit.log" ]; then
  LAST_ROTATION=$(grep "LAST_KEY_ROTATION" security_audit.log | tail -1)
  echo "Last key rotation: $LAST_ROTATION"
else
  echo "⚠️  No key rotation audit log found"
fi
```

## Risk Coverage Mapping

| Risk ID | Test Scenarios | Mitigation |
|---------|---------------|------------|
| SEC-001 | INC-002-INT-001, INC-002-INT-002 | Repository-wide secret detection |
| SEC-002 | INC-002-INT-003, INC-002-E2E-003 | API key revocation verification |
| SEC-003 | INC-002-INT-004, INC-002-E2E-002 | New key functionality validation |
| SEC-004 | INC-002-E2E-004, INC-002-INT-005 | Prevention system validation |
| SEC-005 | INC-002-INT-002 | Git history security audit |

## Recommended Execution Order

### Phase 1: Immediate Security Validation (Blocks Resolution)
1. **INC-002-INT-003**: Verify exposed keys are revoked
2. **INC-002-INT-004**: Validate new keys work correctly  
3. **INC-002-E2E-002**: End-to-end service functionality
4. **INC-002-INT-001**: Repository secret scanning

### Phase 2: Historical Security Assessment
5. **INC-002-INT-002**: Git history secret detection
6. **INC-002-E2E-001**: Complete security audit workflow
7. **INC-002-E2E-003**: Revoked key rejection testing

### Phase 3: Prevention System Validation  
8. **INC-002-E2E-004**: Pre-commit hook testing
9. **INC-002-INT-005**: Secrets management integration
10. **INC-002-UNIT-001**: Secret pattern detection
11. **INC-002-UNIT-002**: API key format validation
12. **INC-002-UNIT-003**: Environment variable sanitization

## Success Criteria for Security Incident Closure

### Critical Requirements (Must Pass)
- All exposed API keys verified as revoked
- New API keys functional across all services
- No secrets detected in current codebase
- Pre-commit hooks preventing future exposures

### Quality Gates Integration
- **FAIL** status until all P0 security tests pass
- **CONCERNS** status acceptable only with approved waivers
- Cannot achieve **PASS** status with any high-severity security findings

## Long-term Security Monitoring

### Automated Alerts
- Daily secret scanning on all branches
- API key rotation reminders (quarterly)
- Failed authentication attempt monitoring
- Pre-commit hook bypass attempts

### Security Metrics
- Days since last secret exposure: Target 0
- API key rotation frequency: Target quarterly
- Security test coverage: Target 95%
- Pre-commit hook success rate: Target 100%