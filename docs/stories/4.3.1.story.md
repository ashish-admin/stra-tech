# Story 4.3.1: SentimentHeatmap Component - Multi-dimensional Sentiment Analysis Visualization

## Status
Draft

## Story
**As a** political campaign strategist analyzing ward-level sentiment patterns,
**I want** an interactive heatmap visualization of multi-dimensional sentiment analysis across all wards,
**so that** I can quickly identify geographical hotspots of political emotions and prioritize strategic interventions across the political landscape.

## Acceptance Criteria

1. **Multi-dimensional Sentiment Visualization**: Display heatmap showing 7 emotion categories (Positive, Anger, Negative, Hopeful, Pride, Admiration, Frustration) with color intensity representing sentiment strength
2. **Ward-based Geographic Mapping**: Integrate with existing ward boundary data to display sentiment overlays on geographical ward divisions
3. **Interactive Exploration**: Click on ward regions to drill down into detailed sentiment breakdown with historical context and trending indicators
4. **Time-series Integration**: Provide time range selector (7, 14, 30, 90 days) with animation showing sentiment evolution over selected period
5. **Real-time Data Integration**: Connect to existing trends API (`/api/v1/trends`) with automatic refresh and SSE streaming support for live updates
6. **Mobile-responsive Design**: Optimize heatmap for mobile devices with touch-friendly interactions and simplified view modes
7. **Performance Optimization**: Efficient rendering for 150+ wards with virtualization and progressive loading techniques

## Tasks / Subtasks

- [ ] Task 1: Core Heatmap Infrastructure (AC: 1, 2)
  - [ ] Create `SentimentHeatmap.jsx` component in `frontend/src/features/analytics/components/` following established component patterns
  - [ ] Implement sentiment color mapping system with 7-emotion gradient scales using hex colors from existing TimeSeriesChart palette
  - [ ] Integrate with GeoJSON ward boundary data from `frontend/public/data/` for geographic overlay rendering
  - [ ] Add ward-based sentiment aggregation logic to combine emotion data with geographic boundaries

- [ ] Task 2: Interactive Exploration Features (AC: 3, 4)
  - [ ] Implement ward selection handlers with tooltip display showing sentiment breakdown and historical context
  - [ ] Create time range selector component with 7/14/30/90 day options integrating with existing useApi patterns
  - [ ] Add sentiment evolution animation system showing temporal changes across selected time periods
  - [ ] Implement drill-down modal displaying detailed ward sentiment metrics and trending indicators

- [ ] Task 3: API Integration and Real-time Updates (AC: 5)
  - [ ] Connect to existing `/api/v1/trends` endpoint using established React Query patterns from TimeSeriesChart
  - [ ] Implement data transformation logic to convert trends API response into heatmap-compatible format
  - [ ] Add SSE streaming support for real-time sentiment updates using existing mobile-optimized SSE client
  - [ ] Create error handling and fallback data display following established error boundary patterns

- [ ] Task 4: Mobile Optimization and Performance (AC: 6, 7)
  - [ ] Implement responsive heatmap layout with touch-optimized interactions for mobile devices
  - [ ] Add ward virtualization for efficient rendering of 150+ geographical regions
  - [ ] Create progressive loading system for large sentiment datasets with performance monitoring
  - [ ] Optimize color calculations and rendering pipeline for low-end mobile devices

- [ ] Task 5: Testing and Integration (AC: 1-7)
  - [ ] Unit tests for sentiment color mapping, geographic integration, and data transformation logic
  - [ ] Integration tests with trends API and ward boundary data sources
  - [ ] Mobile responsiveness testing across device sizes and interaction patterns
  - [ ] Performance testing for large dataset rendering and animation smoothness

## Dev Notes

### Previous Story Insights
From Phase 4.2 Mobile SSE Optimization: Successfully implemented adaptive SSE client with network-aware streaming and battery optimization. The mobile-optimized streaming infrastructure provides the perfect foundation for real-time sentiment heatmap updates without impacting performance on mobile devices.

### Technology Stack Context
[Source: docs/architecture/tech-stack.md#data-visualization]
- **Recharts**: Primary charting library already integrated - consider for color scale legends
- **D3.js**: Available for custom data visualizations when Recharts insufficient - ideal for geographic heatmap rendering
- **Leaflet**: Interactive mapping library already used in LocationMap.jsx - leverage for geographic overlays
- **React-Leaflet**: React bindings for Leaflet - established pattern for map-based components

### Data Models and API Integration
[Source: frontend/src/components/TimeSeriesChart.jsx#EMOTIONS]
- **Emotion Categories**: 7-emotion system already established - ["Positive", "Anger", "Negative", "Hopeful", "Pride", "Admiration", "Frustration"]
- **Color Palette**: Existing emotion colors defined - Positive: "#16a34a", Anger: "#ef4444", etc.
- **API Endpoint**: `/api/v1/trends?ward={ward}&days={days}` returns series data with emotions object per date
- **Data Format**: Response structure: `{ series: [{ date, mentions_total, emotions: { Positive: n, Anger: n, ... }}] }`

### File Locations and Structure
[Source: docs/architecture/source-tree.md#frontend-directory-structure]
- **Component Location**: `frontend/src/features/analytics/components/SentimentHeatmap.jsx` (new analytics feature structure)
- **Ward Data Integration**: `frontend/public/data/wardData.js` for ward metadata
- **GeoJSON Integration**: `backend/app/data/ghmc_wards.geojson` for ward boundaries
- **Styling**: Follow TailwindCSS patterns from existing visualization components

### Component Architecture Integration
[Source: docs/architecture/source-tree.md#frontend-key-files]
- **Dashboard Integration**: `src/components/Dashboard.jsx` will integrate heatmap as major visualization component
- **Ward Context**: `src/contexts/WardContext.jsx` - heatmap should respond to global ward selection changes
- **Error Boundary**: Wrap in existing `src/components/ComponentErrorBoundary.jsx` for resilience
- **API Service**: Use `src/services/api.js` patterns for data fetching with React Query caching

### Performance Standards
[Source: docs/architecture/coding-standards.md#performance-standards]
- **Rendering Performance**: < 2s initial heatmap load for 150+ ward regions
- **Mobile Optimization**: Efficient rendering on devices with limited memory and processing power
- **Animation Performance**: 60fps smooth transitions during time-series animation playback
- **Memory Management**: Prevent memory leaks during extended campaign monitoring sessions

### Testing Requirements
[Source: docs/architecture/coding-standards.md#testing-standards]
- **Component Testing**: React Testing Library tests for user interactions and data rendering
- **Coverage Target**: Minimum 70% test coverage following frontend testing standards
- **Integration Testing**: Verify compatibility with existing Dashboard, Ward Context, and API services
- **Mobile Testing**: Touch interaction and responsive layout validation across device sizes

### Error Handling Standards
[Source: docs/architecture/coding-standards.md#error-handling]
- **Graceful Degradation**: Handle geographic data loading failures without crashing dashboard
- **User-Friendly Messages**: Clear error communication for data unavailable scenarios
- **Retry Mechanisms**: Follow TimeSeriesChart retry pattern with exponential backoff
- **Fallback Display**: Provide tabular sentiment data when heatmap rendering fails

### Geographic Data Integration
[Source: CLAUDE.md - Ward Data Handling]
- **Ward Normalization**: Remove "Ward" prefixes, preserve human names following existing patterns
- **GeoJSON Processing**: Load ward boundary polygons from established geojson endpoints
- **Geographic Linking**: Ward IDs link sentiment data to geographic boundaries for overlay rendering
- **Coordinate System**: Use standard geographic projections compatible with Leaflet mapping

### Real-time Integration
[Source: Phase 4.2 Mobile SSE Implementation]
- **SSE Streaming**: Leverage existing mobile-optimized SSE client for real-time sentiment updates
- **Network Adaptation**: Utilize adaptive heartbeat and bandwidth optimization for heatmap data streaming
- **Battery Optimization**: Respect battery-aware streaming patterns to avoid excessive mobile drain
- **Progressive Updates**: Stream incremental sentiment changes rather than full dataset refreshes

### Accessibility Considerations
[Source: docs/architecture/coding-standards.md - implied accessibility needs]
- **Keyboard Navigation**: Enable keyboard-only navigation through ward regions and controls
- **Screen Reader Support**: Provide alternative text descriptions for sentiment color patterns
- **Color Accessibility**: Ensure sufficient color contrast and provide pattern alternatives for color-blind users
- **Focus Management**: Clear focus indicators for interactive heatmap elements

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | v1.0 | Initial story creation with comprehensive dev notes and Phase 4.3 requirements | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*This section will be populated by the QA agent after implementation review*